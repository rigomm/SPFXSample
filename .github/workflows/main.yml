name: Deploy SPFx to App Catalog

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod') || 'dev' }}
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dotenv-cli
        working-directory: ./src
        run: npm install dotenv-cli

      - name: Install dependencies
        run: npm install

      - name: Install dependencies src
        working-directory: ./src
        run: npm install

      - name: Build SPFx project
        working-directory: ./src
        run: |
          npm run build:dev

      - name: Authenticate to Azure
        run: |
          m365 login --authType password --userName ${{ vars.SVC_USER }} --password ${{ vars.SVC_PASSWORD }}

      - name: Authenticate to Azure
        run: |
          m365 spo app add --filePath src/sharepoint/solution/TherapyGenieProd.sppkg --overwrite
      
   



